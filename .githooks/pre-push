#!/usr/bin/env bash
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ "–ø–æ—Å–ª–µ–¥–Ω–∏–π" —Ç–µ–≥ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Ä–µ–ø–æ

set -euo pipefail

remote="$1"   # –Ω–∞–ø—Ä–∏–º–µ—Ä, "origin"
url="$2"      # URL —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://github.com/user/project.git)

# --- 1) –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ –ø—É—à–∏—Ç—å ---
has_input=0
while read -r local_ref local_sha remote_ref remote_sha; do
  has_input=1
done

if [ "$has_input" -eq 0 ]; then
  # –ù–∏—á–µ–≥–æ –Ω–µ –ø—É—à–∏—Ç—Å—è ‚Üí –º–æ–ª—á–∏–º
  exit 0
fi

# --- 2) –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ remote (–±–µ–∑ –æ—à–∏–±–æ–∫) ---
if ! git ls-remote "$remote" > /dev/null 2>&1; then
  # –ï—Å–ª–∏ GitHub/remote –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –º–æ–ª—á–∞ –≤—ã—Ö–æ–¥–∏–º
  exit 0
fi

# --- 3) –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∏ —É–¥–∞–ª—ë–Ω–Ω—ã–π "–ø–æ—Å–ª–µ–¥–Ω–∏–µ" —Ç–µ–≥–∏ ---

local_tag=$(git tag --sort=-v:refname | head -n1 2>/dev/null || echo "")
remote_tag=$(git ls-remote --tags "$remote" | \
  awk -F/ '{print $3}' | grep -v '\^{}' | \
  sort -V | tail -n1 2>/dev/null || echo "")

# –ï—Å–ª–∏ —Ç–µ–≥–æ–≤ –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
[ -z "$local_tag" ] && exit 0
[ -z "$remote_tag" ] && exit 0

# --- 4) –ï—Å–ª–∏ —Ç–µ–≥–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º ---
if [ "$local_tag" = "$remote_tag" ]; then
  exit 0
fi

# --- 5) –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ ---
border="############################################################"
echo "$border"
echo "üöÄ  –¢–µ–≥ –∏–∑–º–µ–Ω–∏–ª—Å—è $remote_tag ‚Üí $local_tag"
echo "    –ù–∞ github.com –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è workflow –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞."
echo "    –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø—Ä–∏–¥–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram."
echo "$border"

exit 0
