# Telegram Cron Reminder

[![GitHub tag (latest by date)](https://img.shields.io/github/v/tag/vsuh/reminder-tgm?label=version)](https://github.com/vsuh/reminder-tgm/tags)

[![Notify Docker](https://github.com/vsuh/reminder-tgm/actions/workflows/notify-docker.yml/badge.svg)](https://github.com/vsuh/reminder-tgm/actions/workflows/notify-docker.yml)

[![Build and Push Docker](https://github.com/vsuh/cron-tg-docker/actions/workflows/build-and-push.yml/badge.svg)](https://github.com/vsuh/cron-tg-docker/actions/workflows/build-and-push.yml)


Этот проект представляет собой простое приложение для отправки напоминаний в Telegram на основе расписания `cron` и дополнительных модификаторов.  Приложение предоставляет веб-интерфейс и REST API для управления расписаниями. Проект может быть развернут в [docker контейнере](https://github.com/vsuh/cron-tg-docker.git)

> Для отражения изменений в контейнере, после внесения изменений нужно повысить версию и передать ее в удаленный репозитарий.  
Например:

```bash
git tag v1.1.z
git push origin master --tags
```

## Возможности

- **Гибкое расписание:** Поддержка `cron` выражений и дополнительных модификаторов для точной настройки времени отправки напоминаний.
- **Модификаторы:** Расширенные модификаторы `d/n` (каждые n дней) и `w/n` (каждые n недель) с поддержкой начальной даты (YYYYMMDD>).
- **Управление чатами:**  Возможность назначить уведомлению чат Telegram, куда оно будет отправляться.
- **поддержка Shebang:** Возможность загрузки текста уведомления из JSON файла через shebang синтаксис (#!/path/to/file.json).
- **Веб-интерфейс:** Удобный веб-интерфейс для управления расписаниями, добавления, редактирования и удаления напоминаний, а также ведения списка чатов.
- **Экспорт/импорт списка расписаний:** Возможность загрузки расписаний из файла в формате JSON, а также выгрузки.
- **Запуск в Docker:** Поддержка запуска приложения в Docker [см.](https://github.com/vsuh/cron-tg-docker.git). 

## Установка и запуск

### Зависимости

Управление зависимостями осуществляется с помощью файлов `requirements/*.txt`.  

```bash
pip install -r requirements.txt
```

Основные зависимости:

- **Flask:**  Фреймворк для веб-приложения.
- **python-dotenv:**  Для загрузки переменных окружения.
- **croniter:**  Для работы с cron выражениями.
- **requests:**  Для отправки HTTP запросов.
- **pytz:**  Для работы с временными зонами.
- **python-dateutil:**  Для работы с датами и временем.

### Локальный запуск

1. Клонируйте репозиторий:

```bash
   git clone https://github.com/vsuh/cron-reminder.git
```

- Создайте виртуальное окружение и установите зависимости:

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

- Скопируйте файл `env/.env.SAMPLE` в `.env` и настройте переменные окружения:

```sh
cp env/.env.SAMPLE .env
# Отредактируйте .env, заменив значения по умолчанию на ваши
```

- Запустите веб-приложение:

```sh
./web_prod.sh
```

- Запустите фоновый скрипт в режиме разработки (в отдельном терминале):

```bash
start_rund_service.sh
```

## Использование

- Веб-интерфейс

Доступ к веб-интерфейсу осуществляется по адресу http://host:7878 (или на порту, указанному в .env). Вы можете добавлять, редактировать и удалять расписания, а также управлять чатами Telegram через веб-интерфейс.

## API

Приложение предоставляет REST API для управления расписаниями (см. [API](API.md)).

## Модификаторы

Модификаторы позволяют уточнить время срабатывания cron выражения. Поддерживаются следующие модификаторы:

- d/n: Срабатывает каждые n дней.
- w/n: Срабатывает каждые n недель, начиная с понедельника.
- YYYYMMDD>: Указывает начальную дату для отсчета. Например, 20240301>d/3 будет срабатывать каждые 3 дня, начиная с 1 марта 2024 года.

## Shebang функциональность

Приложение поддерживает специальный формат сообщений, начинающихся с shebang синтаксиса:

```
#!relative-path/to/file.json
```

Если сообщение начинается с такой строки (#!), приложение:
1. Читает указанный JSON файл
2. Находит сообщение, соответствующее текущей дате
3. Использует значение поля `text` в качестве текста сообщения

Пример JSON файла с сообщениями:
```json
[
  {
    "date": "2025-12-19",
    "text": "С Днем снабженца!"
  },
  {
    "date": "2025-12-26",
    "text": "С днем ангела-хранителя!"
  }
]
```

В этом формате:
- `date`: дата в формате "YYYY-MM-DD"
- `text`: текст сообщения для этой даты

## Таблица chats

Перед началом заполнения таблицы расписаний, необходимо заполнить таблицу чатов по адресу http://host:7878/chats

## Пример импорта данных

Для первоначального заполнения расписаний можно использовать JSON файл, например, [dataschedules.json](static/dataschedules.json):

```sh
curl -X POST -H "Content-Type: application/json;charset=utf-8" --data-binary @dataschedules.json http://host:7878/schedules_all
```

## Переменные окружения

Для работы приложения необходимо настроить следующие переменные окружения:

### Настройки Telegram бота
- `TLCR_TELEGRAM_TOKEN` - токен вашего бота, полученный у @BotFather
- `TLCR_TELEGRAM_CHAT_ID` - ID чата/группы для отправки сообщений

### Настройки времени
- `TLCR_TZ` - временная зона сервера (например, "Europe/Moscow")

### Настройки базы данных
- `TLCR_DB_PATH` - путь к файлу БД (по умолчанию "db/settings.db")
- `TLCR_BACKUP_PATH` - путь для хранения резервных копий БД
- `TLCR_BACKUP_INTERVAL` - интервал создания резервных копий в часах

### Настройки логирования
- `TLCR_LOGPATH` - директория для хранения логов
- `TLCR_LOG_LEVEL` - уровень логирования (DEBUG, INFO, WARNING, ERROR)

### Настройки веб-интерфейса
- `TLCR_SECRET_KEY` - секретный ключ для Flask (обязательно измените в production)
- `TLCR_LIST_ITEMS` - количество элементов на странице
- `TLCR_FLASK_PORT` - порт для веб-интерфейса

### Настройки планировщика
- `TLCR_CHECK_MINUTES` - интервал проверки расписаний в минутах

### Настройки режима работы
- `FLASK_ENV` - режим работы Flask (development/production)
- `FLASK_DEBUG` - режим отладки (0/1)

Пример файла конфигурации можно найти в `.env.SAMPLE`. Для production-окружения рекомендуется:
- Использовать абсолютные пути для файлов и директорий
- Отключить режим отладки (`FLASK_DEBUG=0`)
- Установить `FLASK_ENV=production`
- Использовать надёжный секретный ключ
- Настроить соответствующий уровень логирования

## Скрипты

- **start_rund_service.sh** - для запуска с помощью cron
- **start_web_service.sh** - systemd приложение
- **start.sh** - точка входа для docker контейнера
- **web_prod.sh** - запуск веб-службы скриптом start.sh
- **rund_prod.sh** - запуск службы проверки расписаний скриптом start.sh
- **web.sh** - запуск вебслужбы в режиме отладки
